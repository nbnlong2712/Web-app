# Story 1.10: Implement Edge Route Handler for Affiliate Redirects

## Status
Draft

## Story
**As a** developer,
**I want** to implement an Edge Route Handler for `/go/[slug]` that logs clicks and redirects to affiliate URLs,
**so that** we can track outbound clicks and ensure fast redirects.

## Acceptance Criteria
1. Edge Route Handler `/go/[slug]` is created
2. Route inserts click data into `clicks` table
3. Route redirects to affiliate URL with HTTP 302
4. Route appends default UTM parameters when missing
5. Route includes basic anti-bot protection
6. Route performs within acceptable latency requirements

## Tasks / Subtasks
- [ ] Create Edge Route Handler
  - [ ] Create `app/go/[slug]/route.ts` with Edge runtime
  - [ ] Implement parameter validation for slug
  - [ ] Set runtime to 'edge'
- [ ] Implement click logging
  - [ ] Look up tool by slug in `tools` table
  - [ ] Insert row into `clicks` table with tool_id, timestamp, referrer, and UTM parameters
  - [ ] Handle database errors gracefully
- [ ] Implement redirect logic
  - [ ] Retrieve affiliate URL from tool record
  - [ ] Append default UTM parameters if missing
  - [ ] Redirect with HTTP 302 status
- [ ] Add anti-bot protection
  - [ ] Ignore HEAD requests
  - [ ] Filter common bad user-agents
  - [ ] Implement light IP rate-limiting
- [ ] Test performance
  - [ ] Verify route performs within latency requirements
  - [ ] Test with various edge cases
  - [ ] Verify error handling

## Dev Notes
### Edge Route Requirements
- Edge Route Handler `/go/[slug]`
- Insert row into `clicks` (tool_id, ts, referrer, utm_*) then 302
- Append `utm_source=ailib&utm_medium=referral&utm_campaign=default` if missing
- Simple anti-bot: ignore HEAD, filter common user-agents, light IP rate-limit

[Source: docs/epic/epic-f-affiliate-redirect-tracking.md]

### Edge & Server Logic
- **/go/[slug] route (Edge)**
  - Lookup tool by slug → insert row in `clicks` (`tool_id`, timestamp, `referrer`, any `utm_*`)
  - Append default UTM if missing (`utm_source=ailib&utm_medium=referral&utm_campaign=default`)
  - 302 to `affiliate_url`
  - Basic antibot: ignore `HEAD`, filter common bad user‑agents, light IP rate‑limit

[Source: docs/architecture/6-edge-server-logic.md]

### Data Model
Tables:
- `clicks`: Outbound click logs, insert-only by anonymous

Schema (DDL):
```sql
create table if not exists clicks (
  id bigserial primary key,
  tool_id uuid references tools(id) on delete set null,
  clicked_at timestamp default now(),
  referrer text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  ip inet
);
```

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### Project Structure
```
ai-tools-library/
├─ app/
│  ├─ go/
│  │  └─ [slug]/
│  │     └─ route.ts                  # Edge redirect + click log
```

[Source: docs/architecture/source-tree.md]

### Performance & Quality Budgets
- Edge routes should have minimal latency
- Database operations should be optimized

[Source: docs/architecture/coding_standards.md#9]

## Testing
### Test file location
- Tests should be placed in `tests/e2e/` directory for end-to-end testing
- Test file: `tests/e2e/affiliate-redirect.test.ts`

### Test standards
- Test redirect functionality with valid slugs
- Verify click logging in database
- Test UTM parameter handling
- Verify anti-bot protection works
- Test error cases (invalid slug, missing tool, etc.)

### Testing frameworks and patterns to use
- Use Playwright for end-to-end testing
- Mock Supabase client for testing database interactions
- Test various user agents for anti-bot functionality
- Verify redirect status codes
- Test performance and latency

[Source: docs/architecture/coding_standards.md#8]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
|      |         |             |        |

## Dev Agent Record
### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

## QA Results
TBD