# Story 1.10: Implement Edge Route Handler for Affiliate Redirects

## Status
Approved

## Story
**As a** developer,
**I want** to implement an Edge Route Handler for `/go/[slug]` that logs clicks and redirects to affiliate URLs,
**so that** we can track outbound clicks and ensure fast redirects.

## Acceptance Criteria
1. Edge Route Handler `/go/[slug]` is created
2. Route inserts click data into `clicks` table
3. Route redirects to affiliate URL with HTTP 302
4. Route appends default UTM parameters when missing
5. Route includes basic anti-bot protection
6. Route performs within acceptable latency requirements

## Tasks / Subtasks
- [x] Create Edge Route Handler
  - [x] Create `app/go/[slug]/route.ts` with Edge runtime
  - [x] Implement parameter validation for slug
  - [x] Set runtime to 'edge'
- [x] Implement click logging
  - [x] Look up tool by slug in `tools` table
  - [x] Insert row into `clicks` table with tool_id, timestamp, referrer, and UTM parameters
  - [x] Handle database errors gracefully
- [x] Implement redirect logic
  - [x] Retrieve affiliate URL from tool record
  - [x] Append default UTM parameters if missing
  - [x] Redirect with HTTP 302 status
- [x] Add anti-bot protection
  - [x] Ignore HEAD requests
  - [x] Filter common bad user-agents
  - [x] Implement light IP rate-limiting
- [x] Test performance
  - [x] Verify route performs within latency requirements
  - [x] Test with various edge cases
  - [x] Verify error handling

## Dev Notes
### Edge Route Requirements
- Edge Route Handler `/go/[slug]`
- Insert row into `clicks` (tool_id, ts, referrer, utm_*) then 302
- Append `utm_source=ailib&utm_medium=referral&utm_campaign=default` if missing
- Simple anti-bot: ignore HEAD, filter common user-agents, light IP rate-limit

[Source: docs/epic/epic-f-affiliate-redirect-tracking.md]

### Edge & Server Logic
- **/go/[slug] route (Edge)**
  - Lookup tool by slug → insert row in `clicks` (`tool_id`, timestamp, `referrer`, any `utm_*`)
  - Append default UTM if missing (`utm_source=ailib&utm_medium=referral&utm_campaign=default`)
  - 302 to `affiliate_url`
  - Basic antibot: ignore `HEAD`, filter common bad user‑agents, light IP rate‑limit

[Source: docs/architecture/6-edge-server-logic.md]

### Data Model
Tables:
- `clicks`: Outbound click logs, insert-only by anonymous

Schema (DDL):
```sql
create table if not exists clicks (
  id bigserial primary key,
  tool_id uuid references tools(id) on delete set null,
  clicked_at timestamp default now(),
  referrer text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  ip inet
);
```

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### Project Structure
```
ai-tools-library/
├─ app/
│  ├─ go/
│  │  └─ [slug]/
│  │     └─ route.ts                  # Edge redirect + click log
```

[Source: docs/architecture/source-tree.md]

### Performance & Quality Budgets
- Edge routes should have minimal latency
- Database operations should be optimized

[Source: docs/architecture/coding_standards.md#9]

## Testing
### Test file location
- Tests should be placed in `tests/e2e/` directory for end-to-end testing
- Test file: `tests/e2e/affiliate-redirect.test.ts`

### Test standards
- Test redirect functionality with valid slugs
- Verify click logging in database
- Test UTM parameter handling
- Verify anti-bot protection works
- Test error cases (invalid slug, missing tool, etc.)

### Testing frameworks and patterns to use
- Use Playwright for end-to-end testing
- Mock Supabase client for testing database interactions
- Test various user agents for anti-bot functionality
- Verify redirect status codes
- Test performance and latency

[Source: docs/architecture/coding_standards.md#8]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
|      |         |             |        |

## Dev Agent Record
### Agent Model Used
James (Full Stack Developer)

### Debug Log References
No debug logs required for this task.

### Completion Notes List
- Created Edge Route Handler with Edge runtime at `app/go/[slug]/route.ts`
- Implemented parameter validation for slug
- Implemented click logging functionality that looks up tool by slug and inserts row into clicks table
- Implemented redirect logic to affiliate URL with HTTP 302 status
- Added anti-bot protection features including HEAD request filtering, bad user-agent filtering, and IP rate-limiting
- Created end-to-end tests for the affiliate redirect functionality
- All tasks completed according to acceptance criteria

### File List
- src/app/go/[slug]/route.ts
- tests/e2e/affiliate-redirect.test.ts

## QA Results
**Status: PASS**

**Gate File:** [epic-f-affiliate-redirect-tracking.1.10-implement-edge-route-handler.md](../qa/gates/epic-f-affiliate-redirect-tracking.1.10-implement-edge-route-handler.md)

**Summary:**
The implementation of the Edge Route Handler for affiliate redirects has been reviewed and passes all quality gates. The route handler correctly logs clicks to the `clicks` table and redirects to affiliate URLs with HTTP 302 status. It properly appends default UTM parameters when missing and includes basic anti-bot protection as required.

**Key Findings:**
- All functional requirements have been met.
- Performance considerations have been properly addressed with Edge runtime.
- Security measures (anti-bot protection) are implemented.
- Error handling is appropriately designed to not block redirects.
- E2E tests cover all required functionality.

**Recommendations:**
1. Consider implementing a more robust rate-limiting solution for production use.
2. Add more comprehensive error handling and monitoring for the click logging functionality.
3. Consider adding unit tests for the route handler to complement the E2E tests.
4. Verify that the UTM parameter handling works correctly with all types of redirect URLs.