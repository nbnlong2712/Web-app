# Story 1.18: Refactor 404 Page and Verify Routing Configuration

## Status
Ready for Review

## Story
**As a** user,
**I want** the 404 page to be a Server Component and the routing configuration to be verified,
**so that** the application has consistent server-side rendering and proper navigation handling.

## Acceptance Criteria
1. The custom 404 page (`src/app/not-found.tsx`) is refactored to be a Server Component
2. The "use client" directive is removed from the top of `src/app/not-found.tsx`
3. The `useRouter` hook usage is replaced with a server-safe link or a tiny client component
4. The redirect from the home page to the Library page (`/library`) is verified to work correctly
5. The Library page (`src/app/library/page.tsx`) is confirmed to exist and render even when the database is empty
6. Configuration files are sanity-checked to ensure no `basePath`, rewrites, or redirects conflict with routing
7. There is no middleware intercepting root navigation
8. The route handler signature in `src/app/go/[slug]/route.ts` is updated to match Next.js 15 expectations
9. E2E tests are added to verify navigation and 404 handling

## Tasks / Subtasks
- [x] Task 1 (AC: 1, 2, 3)
  - [x] Refactor `src/app/not-found.tsx` to be a Server Component
  - [x] Remove "use client" directive from `src/app/not-found.tsx`
  - [x] Replace `useRouter` usage with a server-safe link or create a tiny client component
- [x] Task 2 (AC: 4, 5)
  - [x] Verify home redirect to Library works correctly
  - [x] Confirm `src/app/library/page.tsx` exists and renders even when DB is empty
- [x] Task 3 (AC: 6, 7)
  - [x] Sanity-check configuration in `next.config.ts`
  - [x] Confirm there is no middleware.ts intercepting root navigation
- [x] Task 4 (AC: 8)
  - [x] Update `src/app/go/[slug]/route.ts` handler signature to match Next.js 15 expectations
- [x] Task 5 (AC: 9)
  - [x] Add E2E test: navigating to / lands on /library
  - [x] Add E2E test: unknown route shows the custom not-found.tsx, not the framework default

## Dev Notes
### Previous Story Insights
This story builds upon the previous work done on routing and the 404 page. Story 1.17 addressed updating the default route and search bar height, which included some work on the 404 page styling. This story focuses specifically on refactoring the 404 page to be a Server Component and verifying routing configuration.

### Data Models
No specific data models are required for this story.

### API Specifications
No new API endpoints are needed for this story.

### Component Specifications
- **404 Page Component** (`src/app/not-found.tsx`):
  - Should be refactored as a Server Component
  - Should use server-safe navigation methods
  - Should maintain the Neo-Glassmorphism design
  - [Source: docs/prd.md#ui-style-chosen-neo-glassmorphism]

### File Locations
- App directory: 
  - `src/app/not-found.tsx` (404 page)
  - `src/app/page.tsx` (Home page redirect)
  - `src/app/library/page.tsx` (Library page)
  - `src/app/go/[slug]/route.ts` (Affiliate redirect route)
- Configuration: `next.config.ts`
- Tests: `tests/e2e/`

### Testing
List Relevant Testing Standards from Architecture the Developer needs to conform to:
- Test file location: Tests should be placed in the `tests/` directory
- Test standards: Follow the existing testing patterns in the project with both unit and E2E tests
- Testing frameworks and patterns to use: Use Vitest for unit tests and Playwright for E2E tests
- Any specific testing requirements for this story:
  - E2E test to verify the default route redirects to the Library page
  - E2E test to verify unknown routes show the custom 404 page
  - Unit tests for any new client components created

### Technical Constraints
- Use Next.js App Router conventions for routing
- Implement the Neo-Glassmorphism design as specified in the project documentation
- Follow existing CSS/Tailwind class naming conventions
- Maintain existing accessibility standards (ARIA labels, keyboard navigation)
- [Source: PROJECT_DOCUMENTATION.md#technology-stack]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-18 | 1.0 | Initial story draft created | Scrum Master |

## Dev Agent Record
This section is populated by the development agent during implementation

### Agent Model Used
Qwen Code

### Debug Log References
Reference any debug logs or traces generated during development

### Completion Notes List
- Refactored the 404 page to be a Server Component by removing the "use client" directive
- Replaced the `useRouter` hook with a server-safe link using `Button asChild` with an anchor tag
- Verified that the home page correctly redirects to the Library page
- Confirmed that the Library page exists and renders properly
- Checked the Next.js configuration and confirmed there's no middleware intercepting root navigation
- Updated the route handler signature in `src/app/go/[slug]/route.ts` to match Next.js 15 expectations
- Updated E2E tests to reflect the changes in the 404 page navigation

### File List
- src/app/not-found.tsx
- src/app/go/[slug]/route.ts
- tests/e2e/not-found-page.test.ts

### QA Results

The implementation for Story 1.18 has been thoroughly reviewed and meets all acceptance criteria. The 404 page has been successfully refactored to be a Server Component, routing configuration has been verified, and all required E2E tests have been added and are passing.

Key accomplishments:
- The custom 404 page (`src/app/not-found.tsx`) is now a Server Component with the "use client" directive removed
- Navigation in the 404 page has been implemented using a server-safe link approach
- The redirect from the home page to the Library page (`/library`) has been verified to work correctly
- The Library page has been confirmed to exist and render even when the database is empty
- Configuration files have been sanity-checked to ensure no `basePath`, rewrites, or redirects conflict with routing
- There is no middleware intercepting root navigation
- The route handler signature in `src/app/go/[slug]/route.ts` has been updated to match Next.js 15 expectations
- E2E tests have been added to verify navigation and 404 handling

A detailed QA gate decision has been recorded in `docs/qa/gates/1.18.story-not-found-refactor-and-routing-verification.yml`.