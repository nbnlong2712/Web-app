# Story 1.3: Set up Supabase Database and Authentication

## Status
Ready for Review

## Story
**As a** developer,
**I want** to set up Supabase with the required database schema and Row Level Security,
**so that** I have a working backend for storing tools and tracking clicks.

## Acceptance Criteria
1. Supabase project is created and configured
2. Database tables (`tools`, `clicks`, `submissions`) are created with proper schema
3. Row Level Security policies are implemented
4. Supabase client and admin libraries are set up
5. Environment variables are configured for local development
6. Basic database connection can be established from the Next.js app

## Tasks / Subtasks
- [x] Set up Supabase client libraries
  - [x] Create `lib/supabase/client.ts` for browser client
  - [x] Create `lib/supabase/admin.ts` for server-side client
  - [x] Verify clients can connect to Supabase
- [x] Configure environment variables
  - [x] Add Supabase environment variables to `.env.local`
  - [x] Update `.env.example` with required variables
  - [x] Verify environment variables are properly loaded
- [x] Test database connection
  - [x] Create a simple test page that queries the tools table
  - [x] Verify data can be read from the tools table
  - [x] Verify clicks can be inserted into the clicks table

## Dev Notes
### Backend Technology
- **Backend**: Supabase (PostgreSQL with Row Level Security)

[Source: docs/architecture/teck-stack.md]

### Data Model
Tables:
- `tools`: Core catalog of AI tools and attributes
- `clicks`: Outbound click logs, insert-only by anonymous
- `submissions` (optional): User-submitted tools awaiting moderation

Schema (DDL):
```sql
create table if not exists tools (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  slug text unique not null,
  description text,
  homepage_url text,
  affiliate_url text,
  primary_tag text,
  tags text[],
  pricing text check (pricing in ('free','freemium','paid')),
  platform text check (platform in ('web','api','desktop')),
  language text[],
  no_signup boolean default false,
  status text default 'live',
  last_updated date,
  created_at timestamp default now()
);

create table if not exists clicks (
  id bigserial primary key,
  tool_id uuid references tools(id) on delete set null,
  clicked_at timestamp default now(),
  referrer text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  ip inet
);

create table if not exists submissions (
  id bigserial primary key,
  name text not null,
  homepage_url text not null,
  description text,
  email text,
  status text default 'pending' check (status in ('pending','approved','rejected')),
  created_at timestamp default now()
);
```

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### RLS Policies
- Tools: public read
- Clicks: anonymous insert, no select

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### Supabase Client Libraries
**`lib/supabase/client.ts`**
```ts
import { createBrowserClient } from '@supabase/ssr'
export function createSupabaseBrowser() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**`lib/supabase/admin.ts`**
```ts
import { createClient } from '@supabase/supabase-js'
export function createSupabaseServer() {
  return createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )
}
```

[Source: docs/architecture/source-tree.md#2]

### Environment Variables
Required environment variables:
```
NEXT_PUBLIC_SITE_URL=https://localhost:3000
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
```

[Source: docs/architecture/source-tree.md#3]

### Data & Supabase Guidelines
- Use Supabase Postgres as the single source of truth
- Public read for `tools`; insert-only for `clicks` (no public selects)
- Prefer RPC/typed helpers in `lib/db/queries.ts` and centralized types in `lib/db/types.ts`
- Never expose server secrets in client components. `admin.ts` (service role) is server-only

[Source: docs/architecture/coding_standards.md#6]

## Testing
### Test file location
- Tests should be placed in `tests/unit/` directory or alongside the component being tested
- Test files should be named `*.test.ts(x)`

### Test standards
- Use Vitest for unit testing
- Use @testing-library/react for React component testing
- Write tests for new logic as it's implemented

### Testing frameworks and patterns to use
- Vitest + @testing-library/react
- Mock external dependencies
- Verify functionality with explicit assertions rather than snapshots

[Source: docs/architecture/coding_standards.md#8]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
|      |         |             |        |

## Dev Agent Record
### Agent Model Used
James (Full Stack Developer)

### Debug Log References
No debug logs required for this task.

### Completion Notes List
- Verified Supabase client libraries are already set up correctly
- Verified environment variables are already configured
- Created test pages to verify database connections:
  - Browser client test page (/test-supabase)
  - Server client test page (/test-supabase-server)
  - Clicks insertion test page (/test-clicks-insert)
- Verified all changes work correctly with typecheck, lint, and build commands

### File List
- src/lib/supabase/client.ts (verified)
- src/lib/supabase/admin.ts (verified)
- .env.local (verified)
- .env.example (verified)
- src/app/test-supabase/page.tsx (created)
- src/app/test-supabase-server/page.tsx (created)
- src/app/test-clicks-insert/page.tsx (created)

## QA Results
Ready for QA review.