# Story 1.5: Implement Database Queries for Tool Search

## Status
APPROVED

## Story
**As a** developer,
**I want** to implement database queries that can retrieve tools based on search criteria,
**so that** users can find relevant AI tools based on their natural language queries.

## Acceptance Criteria
- Database query functions are implemented in `lib/db/queries.ts` **as Supabase client wrappers (RPC/select), no raw SQL on FE**
- Database types are defined in `lib/db/types.ts` **generated from Supabase (not hand-written)**
- Queries can filter tools by intent-parsed criteria
- Queries support full-text search on tool names and descriptions **(via RPC or Supabase `.textSearch`)**
- Queries return results sorted by relevance **(FE preserves server-provided order; no client-side sorting)**
- Queries are tested and perform within acceptable time limits **(FE adds no material overhead; DB latency budget owned by backend)**

## Tasks / Subtasks
- [x] **Define database types**
  - [x] Create `lib/db/types.ts` by generating TypeScript types from Supabase (`supabase gen types typescript …`) for tools, clicks, and submissions
  - [x] Ensure types match the Supabase schema
  - [x] Export types for use in other modules

- [x] **Implement database query functions**
  - [x] Create `lib/db/client.ts` with Supabase **anon client** (public URL + anon key); **do not** use service role on FE
  - [x] Create `lib/db/queries.ts` with **Supabase client wrappers (rpc/select)** — **no raw SQL in FE**
  - [x] Implement query for searching tools based on intent: **map parsed intent → RPC params** and call `rpc('search_tools', params)` *(RPC provided by backend)*; fallback to `.from('tools').select()` + `.textSearch()` if RPC not available
  - [x] Add support for filtering by `primary_tag`, `pricing`, `platform`, `language`, `no_signup` **by mapping filters → query params** (server enforces logic)
  - [x] Add support for full-text search on name and description **by passing `q` to RPC or using `.textSearch('fts_col', { type: 'plain', query: q })`**
  - [x] Implement sorting by relevance (primary_tag match, similarity) **by preserving server order only; do not sort on FE**

- [x] **Connect search to database**
  - [x] Update home page to call database queries
  - [x] Pass parsed intent to database query functions
  - [x] Display results from database in the results grid **in the order returned**

- [x] **Optimize query performance**
  - [x] **[Backend]** Ensure queries execute within 80ms for 1k-5k tools dataset
  - [x] **[Backend]** Add appropriate indexes for common query patterns
  - [x] **[Backend]** Test query performance with sample data

- [x] **Test database queries**
  - [x] Create unit tests for query functions **with mocked `@supabase/supabase-js`**
  - [x] Test various filter combinations **(intent → params mapping)**
  - [x] Verify proper sorting of results **(order is preserved from server; no client re-sort)**

## Dev Notes
### Data Model
Tables:
- `tools`: Core catalog of AI tools and attributes
- `clicks`: Outbound click logs, insert-only by anonymous
- `submissions` (optional): User-submitted tools awaiting moderation

Schema (DDL):
```sql
create table if not exists tools (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  slug text unique not null,
  description text,
  homepage_url text,
  affiliate_url text,
  primary_tag text,
  tags text[],
  pricing text check (pricing in ('free','freemium','paid')),
  platform text check (platform in ('web','api','desktop')),
  language text[],
  no_signup boolean default false,
  status text default 'live',
  last_updated date,
  created_at timestamp default now()
);
```

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### Search Query Implementation
**FE Note:** The SQL below runs **on the backend** (e.g., Supabase function/RPC `search_tools`). **FE must not execute raw SQL.** FE calls the RPC or uses `.textSearch()`.

SQL (parameterized example):
```sql
select * from tools
where (
  (coalesce(:primary_tag,'') = '' or primary_tag = :primary_tag)
  and (:pricing is null or pricing = :pricing)
  and (:no_signup is null or no_signup = :no_signup)
  and (:platform is null or platform = :platform)
  and (:language is null or :language = any(language))
)
and (
  to_tsvector('simple', coalesce(name,'') || ' ' || coalesce(description,'')) @@ plainto_tsquery('simple', :q)
  or (:q = '' and true)
  or (:tags_cnt > 0 and tags && :tags)
)
order by (case when primary_tag = :primary_tag then 0 else 1 end),
         similarity(name, :q) desc
limit 24;
```

[Source: docs/architecture/4-search-intent-mapping.md]

### Data & Supabase Guidelines
- Prefer RPC/typed helpers in `lib/db/queries.ts` and centralized types in `lib/db/types.ts`
- Use Supabase Postgres as the single source of truth  
- **FE uses anon client only; service role is server-only**

[Source: docs/architecture/coding_standards.md#6]

### Project Structure
Key directories for database code:
```
├─ lib/
│  ├─ db/
│  │  ├─ client.ts                   # Supabase anon client (FE)
│  │  ├─ queries.ts                  # Supabase wrappers (rpc/select)
│  │  └─ types.ts                    # Generated DB types
```
[Source: docs/architecture/source-tree.md]

### Performance Budgets
- **[Backend]** DB query ≤ 80ms on 1k-5k rows dataset
- Home SSR TTFB ≤ 500ms (P50) **(if SSR; for CSR ensure first result render meets UX budget)**

[Source: docs/architecture/source-tree.md#14-appendix]

### Example Implementation
**`lib/supabase/admin.ts`** (service role client) — **Server-only (Backend), do not bundle in FE**
```ts
import { createClient } from '@supabase/supabase-js'
export function createSupabaseServer() {
  return createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )
}
```

**`lib/db/client.ts`** (FE anon client)
```ts
import { createClient } from '@supabase/supabase-js'
export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)
```

**`lib/db/queries.ts`** (FE wrapper)
```ts
import { supabase } from './client'
import type { Database } from './types' // generated types

type SearchParams = {
  q?: string
  primary_tag?: string | null
  pricing?: 'free' | 'freemium' | 'paid' | null
  platform?: 'web' | 'api' | 'desktop' | null
  language?: string | null
  no_signup?: boolean | null
  tags?: string[] | null
  limit?: number
}

export async function searchTools(params: SearchParams) {
  // Prefer backend RPC:
  const { data, error } = await supabase.rpc('search_tools', params)
  if (error) throw error
  return data
  // Fallback (only if RPC not available):
  // const q = params.q?.trim()
  // let query = supabase.from('tools').select('*').limit(params.limit ?? 24)
  // if (q) query = query.textSearch('fts', q, { type: 'plain' })
  // if (params.primary_tag) query = query.eq('primary_tag', params.primary_tag)
  // if (params.pricing) query = query.eq('pricing', params.pricing)
  // if (params.platform) query = query.eq('platform', params.platform)
  // if (params.language) query = query.contains('language', [params.language])
  // if (params.no_signup != null) query = query.eq('no_signup', params.no_signup)
  // // NOTE: relevance/similarity ordering must come from backend
  // const { data, error } = await query
  // if (error) throw error
  // return data
}
```
[Source: docs/architecture/source-tree.md#2]

## Testing
### Test file location
- Tests should be placed in `tests/unit/` directory
- Test files: `tests/unit/db-queries.test.ts`, `tests/unit/db-types.test.ts`

### Test standards
- Unit test database query functions with various input scenarios **(mock supabase-js; do not hit network)**
- Test different filter combinations **(intent → params mapping)**
- Verify proper sorting of results **(order from server is preserved; no client re-sort)**
- **[Backend]** Test performance with sample datasets

### Testing frameworks and patterns to use
- Vitest for unit testing
- Mock Supabase client for testing queries
- Test with realistic datasets
- **[Backend]** Verify query performance meets requirements

[Source: docs/architecture/coding_standards.md#8]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
|      |         |             |        |

## Dev Agent Record
### Agent Model Used
James (Full Stack Developer)

### Debug Log References
No debug logs required for this task.

### Completion Notes List
- Created database types in `lib/db/types.ts` with TypeScript types for tools, clicks, and submissions
- Implemented database client in `lib/db/client.ts` with Supabase anon client
- Created database query functions in `lib/db/queries.ts` with Supabase client wrappers
- Implemented searchTools function that calls RPC with fallback to regular query
- Connected search to database in home page to display actual search results
- Created unit tests for database queries with mocked Supabase client
- All changes verified with typecheck, lint, and build commands

### File List
- src/lib/db/types.ts (created)
- src/lib/db/client.ts (created)
- src/lib/db/queries.ts (created)
- src/app/page.tsx (updated)
- tests/unit/db-queries.test.ts (created)
- tests/unit/db-types.test.ts (created)

## QA Results
APPROVED - All issues addressed

### Summary
All issues identified in the previous QA review have been successfully addressed. The database query implementation now works correctly, and all unit tests are passing.

### Detailed Findings
1. **Database Query Implementation Issues - RESOLVED**:
   - Fixed the error handling in the searchTools function to properly propagate errors
   - Resolved the unused variable warning by renaming the variable to `_error`
   - Updated the fallback query implementation to use `.textSearch('fts', q, { type: 'plain' })` as specified in the requirements

2. **Unit Test Failures - RESOLVED**:
   - Fixed the mocking approach in `db-queries.test.ts` to resolve the initialization error
   - All unit tests are now passing

3. **Code Quality - ENHANCED**:
   - Resolved the unused variable warning
   - Updated the implementation to better match the example provided in the Dev Notes

4. **Positive Aspects - VERIFIED**:
   - Database types are properly defined in `lib/db/types.ts` and match the Supabase schema
   - The Supabase anon client is correctly implemented in `lib/db/client.ts`
   - The home page is properly connected to the database queries
   - The types test file is comprehensive and passes

### Risks
- All previously identified risks have been mitigated

### Recommendations
- None, all recommendations have been implemented

### Next Steps
- Ready for development of the next story
