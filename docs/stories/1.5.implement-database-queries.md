# Story 1.5: Implement Database Queries for Tool Search

## Status
Draft

## Story
**As a** developer,
**I want** to implement database queries that can retrieve tools based on search criteria,
**so that** users can find relevant AI tools based on their natural language queries.

## Acceptance Criteria
1. Database query functions are implemented in `lib/db/queries.ts`
2. Database types are defined in `lib/db/types.ts`
3. Queries can filter tools by intent-parsed criteria
4. Queries support full-text search on tool names and descriptions
5. Queries return results sorted by relevance
6. Queries are tested and perform within acceptable time limits

## Tasks / Subtasks
- [ ] Define database types
  - [ ] Create `lib/db/types.ts` with TypeScript types for tools, clicks, and submissions
  - [ ] Ensure types match the Supabase schema
  - [ ] Export types for use in other modules
- [ ] Implement database query functions
  - [ ] Create `lib/db/queries.ts` with typed SQL/RPC helpers
  - [ ] Implement query for searching tools based on intent
  - [ ] Add support for filtering by primary_tag, pricing, platform, language, no_signup
  - [ ] Add support for full-text search on name and description
  - [ ] Implement sorting by relevance (primary_tag match, similarity)
- [ ] Connect search to database
  - [ ] Update home page to call database queries
  - [ ] Pass parsed intent to database query functions
  - [ ] Display results from database in the results grid
- [ ] Optimize query performance
  - [ ] Ensure queries execute within 80ms for 1k-5k tools dataset
  - [ ] Add appropriate indexes for common query patterns
  - [ ] Test query performance with sample data
- [ ] Test database queries
  - [ ] Create unit tests for query functions
  - [ ] Test various filter combinations
  - [ ] Verify proper sorting of results

## Dev Notes
### Data Model
Tables:
- `tools`: Core catalog of AI tools and attributes
- `clicks`: Outbound click logs, insert-only by anonymous
- `submissions` (optional): User-submitted tools awaiting moderation

Schema (DDL):
```sql
create table if not exists tools (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  slug text unique not null,
  description text,
  homepage_url text,
  affiliate_url text,
  primary_tag text,
  tags text[],
  pricing text check (pricing in ('free','freemium','paid')),
  platform text check (platform in ('web','api','desktop')),
  language text[],
  no_signup boolean default false,
  status text default 'live',
  last_updated date,
  created_at timestamp default now()
);
```

[Source: docs/architecture/3-data-model-supabase-postgres.md]

### Search Query Implementation
SQL (parameterized example):
```sql
select * from tools
where (
  (coalesce(:primary_tag,'') = '' or primary_tag = :primary_tag)
  and (:pricing is null or pricing = :pricing)
  and (:no_signup is null or no_signup = :no_signup)
  and (:platform is null or platform = :platform)
  and (:language is null or :language = any(language))
)
and (
  to_tsvector('simple', coalesce(name,'') || ' ' || coalesce(description,'')) @@ plainto_tsquery('simple', :q)
  or (:q = '' and true)
  or (:tags_cnt > 0 and tags && :tags)
)
order by (case when primary_tag = :primary_tag then 0 else 1 end),
         similarity(name, :q) desc
limit 24;
```

[Source: docs/architecture/4-search-intent-mapping.md]

### Data & Supabase Guidelines
- Prefer RPC/typed helpers in `lib/db/queries.ts` and centralized types in `lib/db/types.ts`
- Use Supabase Postgres as the single source of truth

[Source: docs/architecture/coding_standards.md#6]

### Project Structure
Key directories for database code:
```
├─ lib/
│  ├─ db/
│  │  ├─ queries.ts                   # typed SQL/RPC helpers
│  │  └─ types.ts                     # DB types
```

[Source: docs/architecture/source-tree.md]

### Performance Budgets
- DB query ≤ 80ms on 1k-5k rows dataset
- Home SSR TTFB ≤ 500ms (P50)

[Source: docs/architecture/source-tree.md#14-appendix]

### Example Implementation
**`lib/supabase/admin.ts`** (service role client)
```ts
import { createClient } from '@supabase/supabase-js'
export function createSupabaseServer() {
  return createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )
}
```

[Source: docs/architecture/source-tree.md#2]

## Testing
### Test file location
- Tests should be placed in `tests/unit/` directory
- Test files: `tests/unit/db-queries.test.ts`, `tests/unit/db-types.test.ts`

### Test standards
- Unit test database query functions with various input scenarios
- Test different filter combinations
- Verify proper sorting of results
- Test performance with sample datasets

### Testing frameworks and patterns to use
- Vitest for unit testing
- Mock Supabase client for testing queries
- Test with realistic datasets
- Verify query performance meets requirements

[Source: docs/architecture/coding_standards.md#8]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
|      |         |             |        |

## Dev Agent Record
### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

## QA Results
TBD